package com.campusFacilities.www.service.Imp;
import java.time.LocalDate;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.campusFacilities.www.model.Library.BookCategory;
import com.campusFacilities.www.model.Library.BookIssueRecord;
import com.campusFacilities.www.model.Library.Books;
import com.campusFacilities.www.model.Library.LibraryMember;
import com.campusFacilities.www.repository.Library.BookCategoryRepository;
import com.campusFacilities.www.repository.Library.BookIssueRecordRepository;
import com.campusFacilities.www.repository.Library.BooksRepository;
import com.campusFacilities.www.repository.Library.LibraryMemberRepository;

@Service
public class LibraryServiceImpl {

	  @Autowired
   private BookCategoryRepository bookCategoryRepository;

    @Autowired
    private BooksRepository booksRepository;

    @Autowired
    private LibraryMemberRepository memberRepository;

    @Autowired
    private BookIssueRecordRepository issueRepository;


    // ================= BOOK =================

    // Add new book
    public Books addBook(Books book) {
        book.setAvailableCopies(book.getTotalCopies());
        book.setStatus(Books.Status.AVAILABLE);
        return booksRepository.save(book);
    }

    // Get all books
    public List<Books> getAllBooks() {
        return booksRepository.findAll();
    }
    
    //Update Books
    public Books updateBook(Long bookId, Books updatedBook) {
              Books existingBook = booksRepository.findById(bookId)
                .orElseThrow(() -> new RuntimeException("Book not found with id: " + bookId));

        existingBook.setTitle(updatedBook.getTitle());
        existingBook.setAuthor(updatedBook.getAuthor());
        existingBook.setIsbn(updatedBook.getIsbn());
        existingBook.setEdition(updatedBook.getEdition());
        existingBook.setPublisher(updatedBook.getPublisher());
        existingBook.setTotalCopies(updatedBook.getTotalCopies());
        existingBook.setAvailableCopies(updatedBook.getAvailableCopies());
        existingBook.setStatus(updatedBook.getStatus());

        return booksRepository.save(existingBook);
    }

        // DELETE BOOK
        public void deleteBook(Long bookId) {

            Books book = booksRepository.findById(bookId)
                    .orElseThrow(() -> new RuntimeException("Book not found with id: " + bookId));

            booksRepository.delete(book);
        }
        //==================BooksCategory====================//
   
        public BookCategory addCategory(BookCategory category) {
            category.setIsDeleted(false);
            return bookCategoryRepository.save(category); 
        }


        // Get All Categories 
        
        public List<BookCategory> getAllCategories() {
            return BookCategoryRepository.findByIsDeletedFalse();
        }

        // Update Category
        public BookCategory updateCategory(Long id, BookCategory updatedCategory) {

            BookCategory existing = categoryRepository.findById(id)
                    .orElseThrow(() -> new RuntimeException("Category not found with id: " + id));

            existing.setCategoryName(updatedCategory.getCategoryName());
            existing.setDescription(updatedCategory.getDescription());
            existing.setStatus(updatedCategory.getStatus());

            return categoryRepository.save(existing);
        }

        //  Delete Category
        public void deleteCategory(Long id) {

            BookCategory category = categoryRepository.findById(id)
                    .orElseThrow(() -> new RuntimeException("Category not found with id: " + id));

            category.setIsDeleted(true);
            BookCategoryRepository.save(category);
        }
    
    // ================= ISSUE =================

    // Issue book
    public BookIssueRecord issueBook(Long bookId, Long memberId) {

        Books book = booksRepository.findById(bookId)
                .orElseThrow(() -> new RuntimeException("Book not found"));

        if (book.getAvailableCopies() <= 0) {
            throw new RuntimeException("Book not available");
        }

        LibraryMember member = memberRepository.findById(memberId)
                .orElseThrow(() -> new RuntimeException("Member not found"));

        // update book stock
        book.setAvailableCopies(book.getAvailableCopies() - 1);
        booksRepository.save(book);

        // create issue record
        BookIssueRecord issue = new BookIssueRecord();
        issue.setBook(book);
        issue.setMember(member);
        issue.setIssueDate(LocalDate.now());
        issue.setDueDate(LocalDate.now().plusDays(14));
        issue.setStatus(BookIssueRecord.Status.ISSUED);

        return issueRepository.save(issue);
    }

    // ================= RETURN =================

    // Return book
    public BookIssueRecord returnBook(Long issueId) {

        BookIssueRecord issue = issueRepository.findById(issueId)
                .orElseThrow(() -> new RuntimeException("Issue record not found"));

        issue.setReturnDate(LocalDate.now());
        issue.setStatus(BookIssueRecord.Status.RETURNED);

        // update book stock
        Books book = issue.getBook();
        book.setAvailableCopies(book.getAvailableCopies() + 1);
        booksRepository.save(book);

        return issueRepository.save(issue);
    }

    // ================= REPORT =================

    // Get all issued books
    public List<BookIssueRecord> getAllIssuedBooks() {
        return issueRepository.findAll();
    }
}
