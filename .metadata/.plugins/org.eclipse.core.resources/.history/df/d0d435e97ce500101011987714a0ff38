package com.campusFacilities.www.service.Imp;

import java.time.LocalDate;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.campusFacilities.www.model.Library.BookIssueRecord;
import com.campusFacilities.www.model.Library.Books;
import com.campusFacilities.www.model.Library.LibraryMember;
import com.campusFacilities.www.repository.Library.BookIssueRecordRepository;
import com.campusFacilities.www.repository.Library.BooksRepository;
import com.campusFacilities.www.repository.Library.LibraryMemberRepository;

@Service
public class LibraryServiceImpl {

    @Autowired
    private BooksRepository booksRepository;

    @Autowired
    private LibraryMemberRepository memberRepository;

    @Autowired
    private BookIssueRecordRepository issueRepository;

    // ================= BOOK =================

    // Add new book
    public Books addBook(Books book) {
        book.setAvailableCopies(book.getTotalCopies());
        book.setStatus(Books.Status.AVAILABLE);
        return booksRepository.save(book);
    }

    // Get all books
    public List<Books> getAllBooks() {
        return booksRepository.findAll();
    }

    // ================= ISSUE =================

    // Issue book
    public BookIssueRecord issueBook(Long bookId, Long memberId) {

        Books book = booksRepository.findById(bookId)
                .orElseThrow(() -> new RuntimeException("Book not found"));

        if (book.getAvailableCopies() <= 0) {
            throw new RuntimeException("Book not available");
        }

        LibraryMember member = memberRepository.findById(memberId)
                .orElseThrow(() -> new RuntimeException("Member not found"));

        // update book stock
        book.setAvailableCopies(book.getAvailableCopies() - 1);
        booksRepository.save(book);

        // create issue record
        BookIssueRecord issue = new BookIssueRecord();
        issue.setBook(book);
        issue.setMember(member);
        issue.setIssueDate(LocalDate.now());
        issue.setDueDate(LocalDate.now().plusDays(14));
        issue.setStatus(BookIssueRecord.Status.ISSUED);

        return issueRepository.save(issue);
    }

    // ================= RETURN =================

    // Return book
    public BookIssueRecord returnBook(Long issueId) {

        BookIssueRecord issue = issueRepository.findById(issueId)
                .orElseThrow(() -> new RuntimeException("Issue record not found"));

        issue.setReturnDate(LocalDate.now());
        issue.setStatus(BookIssueRecord.Status.RETURNED);

        // update book stock
        Books book = issue.getBook();
        book.setAvailableCopies(book.getAvailableCopies() + 1);
        booksRepository.save(book);

        return issueRepository.save(issue);
    }

    // ================= REPORT =================

    // Get all issued books
    public List<BookIssueRecord> getAllIssuedBooks() {
        return issueRepository.findAll();
    }
}
